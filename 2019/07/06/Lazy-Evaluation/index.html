<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
        <link rel="shortcut icon" type="image/x-icon" href="./favicon.ico">
        <link rel="icon" type="image/png" href="./favicon.png">
        <link rel="apple-touch-icon" href="./favicon180x180.png" sizes="180x180">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link href="https://fonts.googleapis.com/css?family=Josefin+Sans:400,400i,600,600i" rel="stylesheet">
    
<link rel="stylesheet" href="/css/highlight.css">

    
<link rel="stylesheet" href="/css/main.css">

    <title>reyshawn.C</title>
<meta name="generator" content="Hexo 6.0.0"></head>

<body class='home blog'>
    <header id="hagoromo-header" class="hagoromo-header">
    <div class="container">
        <div class="slot-l">
            <div class="hagoromo-site-branding">
                <h1 class="site-title h4">
                    <a href="/"><img class="typology-logo" src="/images/logo.png" alt="hagoromo" style="width: 125px;"></a>
                </h1>
            </div>
        </div>
        <div class="slot-r">
            <ul class="hagoromo-nav hagoromo-actions-list">
                <li class="hagoromo-action-button hagoromo-action-sidebar">
                    <span><i class="fa fa-bars"></i></span>
                </li>
            </ul>
        </div>
    </div>
</header>
<div id="hagoromo-cover" class="hagoromo-cover hagoromo-cover-empty"></div>

    <div class="hagoromo-fake-bg">
        <div class="hagoromo-section">
    <div class="section-content">
        <article class="hagoromo-post">
            <header class="entry-header">
                <h2 class="entry-title h1">
                    <a href="/2019/07/06/Lazy-Evaluation/">Lazy Evaluation, foldr | 5kyu</a>
                </h2>
                <div class="entry-meta">
                    2019 年 07 月 06 日
                </div>
                <div class="post-letter"></div>
            </header>
            <div class="entry-content">
                <p>关于 lazy evaluation，首先要明白两个概念：call by name 和 call by value：</p>
<pre><code class="javascript">// Evaluates with call-by-name strategy
1 function callByName (a, b) &#123;
2  if (a === 1) &#123;
3    return 10
4  &#125;
5  return a + b
6 &#125;
// Evaluates with call-by-value strategy
1 function callByValue (a, b) &#123;
2  if (a === 1) &#123;
3    return 10
4  &#125;
5  return a + b
6 &#125;
</code></pre>
<p>两个函数在形式上没有什么区别，只是在运行时采取了不同的策略或态度，前者是 lazy，后者是 eager；</p>
<pre><code class="shell">&gt; callByName (1, 2 + 3)
&gt; a === 1
&gt; return 10

&gt; callByValue(1, 2 + 3)
&gt; callByValue(1, 5)
&gt; a === 1
&gt; return 10
</code></pre>
<p>使用 lazy evaluation，只用当真正需要读取这个变量或 expression 的时候，才会对其进行运算或 evaluate，也就是字面意义上的 call by need。</p>
<p>实现 lazy evaluation 有很多方法，但其核心概念则是 functional programming。即我们把所有的 variable 写成函数的形式，这样的函数通常被称为 thunk：</p>
<span id="more"></span>

<pre><code class="javascript">// Not lazy
var value = 1 + 1  // immediately evaluates to 2

// Lazy
var lazyValue = () =&gt; 1 + 1  // Evaluates to 2 when lazyValue is *invoked*

// Not lazy
var add = (x, y) =&gt; x + y
var result = add(1, 2)  // Immediately evaluates to 3

// Lazy
var addLazy = (x, y) =&gt; () =&gt; x + y;
var result = addLazy(1, 2)  // Returns a thunk which *when evaluated* results in 3.
</code></pre>
<p>理解了这一概念，就明白 codewars 上这道题目的用意了。</p>
<p><a target="_blank" rel="noopener" href="https://www.codewars.com/kata/foldr/javascript">https://www.codewars.com/kata/foldr/javascript</a></p>
<p>题目很长，简单概括就是，我们需要实现一个 lazy evaluation 版本的 <code>reduceRight()</code> 函数。再把问题简化就是，如何实现上述所说的 call by need，举例来说，以 <code>indexOf</code> 函数为例：</p>
<pre><code class="javascript">const indexOf = y =&gt; function (x, z) &#123;
  if (x === y) &#123;
    return 0
  &#125; else &#123;
    return z + 1 || -1
  &#125;
&#125;;
</code></pre>
<p><code>indexOf</code> 返回的是一个函数，比如 <code>indexOf(1)</code> 函数有两个参数 x 和 z，在 x 值为 1 的时候是 0，其他值时为 z+1。我们需要做的是对参数 z 实现 lazy evaluation，那么按照上述 functional programming 的概念，则应该是：</p>
<pre><code class="javascript">const indexOf = y =&gt; function (x, () =&gt; someFunction()) &#123;
  if (x === y) &#123;
    return 0
  &#125; else &#123;
    return z() + 1 || -1
  &#125;
&#125;;
</code></pre>
<p>这样，当 x 和 y 值相等时，函数直接返回值，z，也就是 someFunction 不会被调用，z 值实现了 lazy evaluation。很完美，不是吗？但问题是，<code>indexOf</code> 函数仅仅是用来测试的一个例子，对于函数内容是不可控也是未知的，我们无法亲自修改，把 <code>return z + 1 || -1</code>  改成 <code>return z() + 1 || -1</code>。</p>
<p>所以，问题最终就变成了，如何将一个变量，比如 <code>z</code>，在他需要使用，参与运算，被读取时才会 evaluate 它的值。答案是 <code>Object.prototype.valueOf()</code>。</p>
<blockquote>
<p>JavaScript calls the <code>valueOf</code> method to convert an object to a primitive value. You rarely need to invoke the <code>valueOf</code> method yourself; JavaScript automatically invokes it when encountering an object where a primitive value is expected.</p>
</blockquote>
<p>使用 <code>valueOf()</code> ，可以</p>
<pre><code class="javascript">&gt; a = &#123;&#125;
&#123;&#125;
&gt; a.valueOf = () =&gt; 3
[Function]
&gt; a 
&#123; valueOf: [Function] &#125;
&gt; a + 1
4
&gt; a.valueOf = () =&gt; true
[Function]
&gt; !a 
false
&gt; a &amp;&amp; false 
false
&gt; 
</code></pre>
<p>定义了 <code>valueOf</code> 方法后，Object a 可以像普通变量，更确切是 primitive value 那样进行运算，而且就如 lazy evaluation 那样，只有它被使用时，<code>valueOf</code> 函数才会被调用。因此，我们只需要在调用 <code>indexOf</code> 函数时这样调用：</p>
<pre><code class="javascript">indexOf(1)(1, &#123;valueOf: () =&gt; someFunction()&#125;)
</code></pre>
<p>即可。依照这样的思路，这道 codewars 问题也就迎刃而解。</p>
<p>参考链接：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://hackernoon.com/lazy-evaluation-in-javascript-84f7072631b7">Lazy Evaluation in Javascript</a></li>
<li><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/38904865/meaning-of-lazy-evaluation-in-javascript">Meaning of Lazy Evaluation in Javascript</a></li>
<li><a target="_blank" rel="noopener" href="https://developer.mozilla.org/en/docs/Web/JavaScript/Reference/Global_Objects/Object/valueOf">Object.prototype.valueOf()</a></li>
</ul>

            </div>
            <div class="entry-tags">
                 
                    <a href="/tags/codewars/">codewars</a>
                 
                    <a href="/tags/JavaScript/">JavaScript</a>
                
            </div>
            <div class="entry-footer"></div>
        </article>
    </div>
</div>
        <footer id="hagoromo-footer" class="hagoromo-footer">
    <div class="container">
        <div class="hagoromo-footer-widget"></div>
        <div class="hagoromo-footer-widget">
            <img class="typology-logo" src="/images/footer.png" alt="hagoromo" style="width: 125px;">
            <p>Inspired by <a target="_blank" rel="noopener" href="https://demo.mekshq.com/typology/">typology</a> · Powered by <a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a> <br> All rights reserved</p>
        </div>
        <div class="hagoromo-footer-widget social">
            
                
                    <span class="social-button">
                        <a target="_blank" href="https://github.com/Reyshawn" rel="alternate noopener"><i class="fa fa-github"></i></a>
                    </span>
                
                    <span class="social-button">
                        <a target="_blank" href="https://twitter.com/ReshawnChang" rel="alternate noopener"><i class="fa fa-twitter"></i></a>
                    </span>
                
            
            <span class="social-button">
                <a href="/atom.xml" rel="alternate"><i class="fa fa-rss"></i></a>
            </span>
        </div> 
    </div>
</footer>
    </div>

    <div class="hagoromo-sidebar">
    <div class="hagoromo-sidebar-header">
        <div class="hagoromo-sidebar-header-wrapper">
            <div class="hagoromo-site-branding">
                <h1 class="site-title h4">
                    <a href="/"><img class="typology-logo" src="/images/logo.png" alt="hagoromo" style="width: 125px;"></a>
                </h1>
            </div>
            <span class="hagoromo-sidebar-close">
                <i class="fa fa-times" aria-hidden="true"></i>
            </span>
        </div>
    </div>
    <div class="widget search">
        <form id="hagoromo-search-form" class="hagoromo-search-form">
            <input name="s" type="text" placeholder="Type here to search ... ">
            <button type="submit" class="hagoromo-button hagoromo-button-search">SEARCH</button>
        </form>
    </div>
    <div class="widget categories">
        <h4 class="widget-title h5">分类</h4>
        <ul>
            <li><a href="/archives">Archive</a></li>
              
            <li><a href="/categories/Coding/">Coding</a></li>
              
            <li><a href="/categories/I-O/">I/O</a></li>
            
        </ul>
    </div>
    <div class="widget tags">
        <h4 class="widget-title h5">标签</h4>
        <ul>
              
                <li><a href="/tags/Algorithm/">Algorithm<a></li>
              
                <li><a href="/tags/codewars/">codewars<a></li>
              
                <li><a href="/tags/Python/">Python<a></li>
              
                <li><a href="/tags/%E7%94%B5%E5%BD%B1/">电影<a></li>
              
                <li><a href="/tags/%E6%B8%B8%E6%88%8F/">游戏<a></li>
              
                <li><a href="/tags/%E9%9F%B3%E4%B9%90/">音乐<a></li>
              
                <li><a href="/tags/JavaScript/">JavaScript<a></li>
              
                <li><a href="/tags/Anime/">Anime<a></li>
              
                <li><a href="/tags/%E6%95%85%E4%BA%8B/">故事<a></li>
              
                <li><a href="/tags/Front-end/">Front-end<a></li>
              
                <li><a href="/tags/Node-js/">Node.js<a></li>
            
        </ul>
    </div>
</div>

<div class="hagoromo-sidebar-overlay"></div>

    
<script src="/js/jquery-3.3.1.min.js"></script>

    
<script src="/js/highlight.min.js"></script>

    
<script src="/js/highlightjs-line-numbers.js"></script>

    
<script src="/js/main.js"></script>

</body>
</html>