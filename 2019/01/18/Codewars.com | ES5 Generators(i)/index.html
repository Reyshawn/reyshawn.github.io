<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
        <link rel="shortcut icon" type="image/x-icon" href="./favicon.ico">
        <link rel="icon" type="image/png" href="./favicon.png">
        <link rel="apple-touch-icon" href="./favicon180x180.png" sizes="180x180">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link href="https://fonts.googleapis.com/css?family=Josefin+Sans:400,400i,600,600i" rel="stylesheet">
    
<link rel="stylesheet" href="/css/highlight.css">

    
<link rel="stylesheet" href="/css/main.css">

    <title>reyshawn.C</title>
<meta name="generator" content="Hexo 6.0.0"></head>

<body class='home blog'>
    <header id="hagoromo-header" class="hagoromo-header">
    <div class="container">
        <div class="slot-l">
            <div class="hagoromo-site-branding">
                <h1 class="site-title h4">
                    <a href="/"><img class="typology-logo" src="/images/logo.png" alt="hagoromo" style="width: 125px;"></a>
                </h1>
            </div>
        </div>
        <div class="slot-r">
            <ul class="hagoromo-nav hagoromo-actions-list">
                <li class="hagoromo-action-button hagoromo-action-sidebar">
                    <span><i class="fa fa-bars"></i></span>
                </li>
            </ul>
        </div>
    </div>
</header>
<div id="hagoromo-cover" class="hagoromo-cover hagoromo-cover-empty"></div>

    <div class="hagoromo-fake-bg">
        <div class="hagoromo-section">
    <div class="section-content">
        <article class="hagoromo-post">
            <header class="entry-header">
                <h2 class="entry-title h1">
                    <a href="/2019/01/18/Codewars.com%20%7C%20ES5%20Generators(i)/">ES5 Generators(i) 和闭包 closure</a>
                </h2>
                <div class="entry-meta">
                    2019 年 01 月 18 日
                </div>
                <div class="post-letter"></div>
            </header>
            <div class="entry-content">
                <h2 id="Kata"><a href="#Kata" class="headerlink" title="Kata"></a>Kata</h2><p>Description:</p>
<p>This is the first part of three (<a target="_blank" rel="noopener" href="http://www.codewars.com/kata/es5-generators-ii">part2</a>, <a target="_blank" rel="noopener" href="http://www.codewars.com/kata/es5-generators-iii">part3</a>).</p>
<p>Generators and Iterators are new ES6 features that will allow things like this:</p>
<pre><code class="javascript">function* fibonacci() &#123;
    let [prev, curr] = [0, 1];
    for (;;) &#123;
        [prev, curr] = [curr, prev + curr];
        yield curr;
    &#125;
&#125;
</code></pre>
<p>Using them in this way, we can do amazing things:</p>
<pre><code class="javascript">let seq = fibonacci();
print(seq.next()); // 1
print(seq.next()); // 2
print(seq.next()); // 3
print(seq.next()); // 5
print(seq.next()); // 8
</code></pre>
<p>This is powerful, but until a few months later, ES6 will not be born.</p>
<p>The goal of this kata is to implement pseudo-generators with ES5.</p>
<span id="more"></span>

<p>The first thing to do is to implement the generator function:</p>
<pre><code class="javascript">function generator(sequencer) &#123;
   ...
&#125;
</code></pre>
<p><code>generator(sequencer[, arg1, arg2, …])</code> receives a sequencer function to generate the sequence and returns and object with a <code>next()</code> method. When the <code>next()</code> method is invoked, the next value is generated. The method could receive as well optional arguments to be passed to the sequencer function.</p>
<p>This is an example of a dummy sequencer:</p>
<pre><code class="javascript">function dummySeq() &#123;
  return function() &#123;
    return &quot;dummy&quot;;
  &#125;;
&#125;
</code></pre>
<p>To test generator(), you could use <code>dummySeq()</code> in this way:</p>
<pre><code class="javascript">var seq = generator(dummySeq);
seq.next(); // &#39;dummy&#39;
seq.next(); // &#39;dummy&#39;
seq.next(); // &#39;dummy&#39;
....
</code></pre>
<p>When you’re done, you should implement the following generators (I think the functions are self explanatory):</p>
<pre><code class="javascript">function factorialSeq() &#123;...&#125; // 1, 1, 2, 6, 24, ...
function fibonacciSeq() &#123;...&#125; // 1, 1, 2, 3, 5, 8, 13, ...
function rangeSeq(start, step) &#123;...&#125; // rangeSeq(1, 2)  -&gt; 1, 3, 5, 7, ...
function primeSeq() &#123;...&#125; // 2, 3, 5, 7, 11, 13, ...
partialSumSeq(1, 3, 7, 2, 0) &#123;...&#125; // 1, 4, 11, 13, 13, end
</code></pre>
<p>You can use any of them in the same way:</p>
<pre><code class="javascript">var seq = generator(factorialSeq);
seq.next(); // !0 = 1
seq.next(); // !1 = 1
seq.next(); // !2 = 2
seq.next(); // !3 = 6
seq.next(); // !4 = 24
...
</code></pre>
<p>There are some sequences which are infinite and others are not. For example:</p>
<ul>
<li>  primeSeq: Is infinite</li>
<li>  partialSumSeq: Is limited to the passed values.</li>
</ul>
<p>When the sequence is done (in finite sequences), if you call seq.next() again, it should produce an error.</p>
<p>Good luck!</p>
<h2 id="Solutions"><a href="#Solutions" class="headerlink" title="Solutions"></a>Solutions</h2><p>题目的大体含义是想要通过 ES5 来模拟 ES6 中才有的 generator 生成器功能。主要思路就是使用闭包 closure 这一特性：</p>
<pre><code class="javascript">function generator(sequencer) &#123;
    var args = Array.prototype.slice.call(arguments, 1);
    return &#123;
        next: sequencer.apply(this,args)
    &#125;;
&#125;

function fibonacciSeq() &#123;
    var prev = 0
    var current = 1
    return function() &#123;
        var old = current
        current = prev + current
        prev = old
        return prev
    &#125;
&#125;

// 直接调用
console.log(fibonacciSeq()())
// 使用 closure
var seq = fibonacciSeq()
console.log(seq())
</code></pre>
<p>关于 Closure，非常推荐阅读 Kyle Simpson 写的 <em>You Don’t Know JS: Scope &amp; Closures</em> ，不到 100 页的小册子，由浅入深，通俗易懂。Closure 简单来讲，就是在一个函数内部定义一个嵌套的子函数，并 return 它，return 这个子函数。形式就像上面代码，在 <code>fibonacciSeq()</code> 函数里 return 了一个 anonymous function，匿名函数。这样做的好处就是，把 <code>fibonacciSeq()</code> 私有变量 <code>prev</code>, <code>current</code> 保护起来，<strong>同时又能通过返回的 anonymous function 去修改函数的私有变量</strong>。听起来很绕。很实用，因为一般来讲，我们是无法在函数的外部去修改一个函数内部的私有变量的，但 closure 却可以。或者换句话，通过「在函数 A 中返回一个子函数」这样的操作，可以去修改函数 A 的私有变量。</p>
<p>这里关于 closure，主要想提及几个点：</p>
<p>一、<code>fibonacciSeq()()</code> 和 <code>seq()</code> 区别</p>
<p>二者函数的调用和执行都不同。<code>fibonacciSeq()()</code> 则是先调用函数 <code>fibonacciSeq()</code>，该函数返回一个匿名函数，再继续调用该匿名函数，得到匿名函数的返回值。所以是连续调用了两个函数，外层函数和内层函数，整个 <code>fibonacciSeq()</code> 函数中的语句都被执行了。</p>
<p>而使用 closure，首先定义变量 <code>var seq = fibonacciSeq()</code>，然后在调用 <code>seq()</code> 的过程中，仅仅调用执行了 <code>fibonacciSeq()</code> 里内部返回的的匿名函数，换句话说，在执行 <code>seq()</code> 的过程中， <code>fibonacciSeq()</code>  函数并没有被调用执行，整个过程真正调用执行的<strong>只有</strong>被嵌套的内层子函数，也就是返回的匿名函数，anonymous function。</p>
<p>这么一个简单区别就造成了，前者 <code>fibonacciSeq()()</code> 即便调用无数次，输出结果都是相同的，都是 <code>1</code>。而后者调用多次，却能够得到 Fibonacci 数列 <code>1,1,2,3,5…</code>。原因就在于 closure，虽然仅仅执行了匿名函数，但因为匿名函数是作为子函数存在于  <code>fibonacciSeq()</code>  函数内，所以根据 Lexical scope 的规则，内层函数是可以 access 到外层函数的变量的。所以在执行 <code>seq()</code> 的过程中，程序从内到外寻找变量  <code>prev</code>, <code>current</code>， 不仅在 <code>fibonacciSeq()</code>  找到了它的私有变量  <code>prev</code>, <code>current</code> ，而且还修改了它们的值！被修改了值的私有变量依旧保持在原来位置，即仍然作为函数的私有变量存在。这一点在文章 <a target="_blank" rel="noopener" href="https://javascript.info/closure">Closure - The Modern JavaScript Tutorial</a> 中有梗详细的解释，这里就不赘述了。</p>
<p>二、其他一些细节</p>
<p>在 <code>generator()</code> 中使用的 <code>call()</code> <code>apply()</code> 方法，主要是为了函数传参。 </p>
<ul>
<li>  <code>Array.prototype.slice.call(arguments, 1)</code> </li>
</ul>
<p>因为 <code>arguments</code> 是一个 array-like object，而不是真正的 array，所以无法使用 array 的诸多方法，包括 slice。<code>call()</code> 的作用就是让 <code>arguments</code> 用上 slice 方法。在这里去掉了  <code>arguments</code> 里的第一个元素，剩下元素作为一个新的 array 存储到 <code>args</code> 中。</p>
<ul>
<li>  <code>sequencer.apply(this,args)</code></li>
</ul>
<p>绑定 this 到 <code>sequencer </code> 并将参数 <code>args</code> 传递到函数中。</p>
<p>参考：</p>
<ul>
<li>  <a target="_blank" rel="noopener" href="https://www.quora.com/What-are-the-reasons-to-use-return-function-in-JavaScript">What are the reasons to use ‘return function’ in JavaScript? - Quora</a></li>
<li>  <a target="_blank" rel="noopener" href="https://javascript.info/closure">Closure - The Modern JavaScript Tutorial</a> ✪</li>
<li>  You Don’t Know JS: Scope &amp; Closures - Kyle Simpson</li>
</ul>

            </div>
            <div class="entry-tags">
                 
                    <a href="/tags/Algorithm/">Algorithm</a>
                 
                    <a href="/tags/codewars/">codewars</a>
                 
                    <a href="/tags/JavaScript/">JavaScript</a>
                
            </div>
            <div class="entry-footer"></div>
        </article>
    </div>
</div>
        <footer id="hagoromo-footer" class="hagoromo-footer">
    <div class="container">
        <div class="hagoromo-footer-widget"></div>
        <div class="hagoromo-footer-widget">
            <img class="typology-logo" src="/images/footer.png" alt="hagoromo" style="width: 125px;">
            <p>Inspired by <a target="_blank" rel="noopener" href="https://demo.mekshq.com/typology/">typology</a> · Powered by <a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a> <br> All rights reserved</p>
        </div>
        <div class="hagoromo-footer-widget social">
            
                
                    <span class="social-button">
                        <a target="_blank" href="https://github.com/Reyshawn" rel="alternate noopener"><i class="fa fa-github"></i></a>
                    </span>
                
                    <span class="social-button">
                        <a target="_blank" href="https://twitter.com/ReshawnChang" rel="alternate noopener"><i class="fa fa-twitter"></i></a>
                    </span>
                
                    <span class="social-button">
                        <a target="_blank" href="http://weibo.com/u/1724849591" rel="alternate noopener"><i class="fa fa-weibo"></i></a>
                    </span>
                
                    <span class="social-button">
                        <a target="_blank" href="https://www.douban.com/people/53350454/" rel="alternate noopener"><i class="fa fa-film"></i></a>
                    </span>
                
                    <span class="social-button">
                        <a target="_blank" href="https://www.zhihu.com/people/zhang-yun-xiao-61/activities" rel="alternate noopener"><i class="fa fa-globe"></i></a>
                    </span>
                
            
            <span class="social-button">
                <a href="/atom.xml" rel="alternate"><i class="fa fa-rss"></i></a>
            </span>
        </div> 
    </div>
</footer>
    </div>

    <div class="hagoromo-sidebar">
    <div class="hagoromo-sidebar-header">
        <div class="hagoromo-sidebar-header-wrapper">
            <div class="hagoromo-site-branding">
                <h1 class="site-title h4">
                    <a href="/"><img class="typology-logo" src="/images/logo.png" alt="hagoromo" style="width: 125px;"></a>
                </h1>
            </div>
            <span class="hagoromo-sidebar-close">
                <i class="fa fa-times" aria-hidden="true"></i>
            </span>
        </div>
    </div>
    <div class="widget search">
        <form id="hagoromo-search-form" class="hagoromo-search-form">
            <input name="s" type="text" placeholder="Type here to search ... ">
            <button type="submit" class="hagoromo-button hagoromo-button-search">SEARCH</button>
        </form>
    </div>
    <div class="widget categories">
        <h4 class="widget-title h5">分类</h4>
        <ul>
            <li><a href="/archives">Archive</a></li>
              
            <li><a href="/categories/Coding/">Coding</a></li>
              
            <li><a href="/categories/I-O/">I/O</a></li>
            
        </ul>
    </div>
    <div class="widget tags">
        <h4 class="widget-title h5">标签</h4>
        <ul>
              
                <li><a href="/tags/Algorithm/">Algorithm<a></li>
              
                <li><a href="/tags/codewars/">codewars<a></li>
              
                <li><a href="/tags/Python/">Python<a></li>
              
                <li><a href="/tags/%E7%94%B5%E5%BD%B1/">电影<a></li>
              
                <li><a href="/tags/%E6%B8%B8%E6%88%8F/">游戏<a></li>
              
                <li><a href="/tags/%E9%9F%B3%E4%B9%90/">音乐<a></li>
              
                <li><a href="/tags/JavaScript/">JavaScript<a></li>
              
                <li><a href="/tags/Front-end/">Front-end<a></li>
              
                <li><a href="/tags/Anime/">Anime<a></li>
              
                <li><a href="/tags/%E6%95%85%E4%BA%8B/">故事<a></li>
              
                <li><a href="/tags/Node-js/">Node.js<a></li>
            
        </ul>
    </div>
</div>

<div class="hagoromo-sidebar-overlay"></div>

    
<script src="/js/jquery-3.3.1.min.js"></script>

    
<script src="/js/highlight.min.js"></script>

    
<script src="/js/highlightjs-line-numbers.js"></script>

    
<script src="/js/main.js"></script>

</body>
</html>